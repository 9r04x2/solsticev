import{a as h}from"./chunk-GZ7HLBKI.js";var p=`
  precision mediump float;
  attribute vec2 a_position;
  attribute vec2 a_texcoord;
  uniform mat3 u_matrix;
  varying vec2 textureCoordinate;
  void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
    textureCoordinate = a_texcoord;
  }
`,x=`
precision mediump float;
varying vec2 textureCoordinate;
uniform sampler2D external_texture;
uniform float borderWidthPx;
uniform vec4 borderColor;
uniform vec2 viewportSize;

void main() {
    vec2 borderWidth = borderWidthPx / viewportSize;
    
    vec2 dist = min(textureCoordinate * viewportSize, 
                    (1.0 - textureCoordinate) * viewportSize);
    
    if (borderWidthPx > 0.0 && (dist.x < borderWidthPx || dist.y < borderWidthPx)) {
        gl_FragColor = borderColor;
    } else {
        gl_FragColor = texture2D(external_texture, textureCoordinate);
    }
}
`;function w(e,r,t){let i=e.createShader(r);if(!i)throw new Error("Failed to create shader");e.shaderSource(i,t),e.compileShader(i);let o=e.getShaderInfoLog(i);return o&&console.error(o),i}function A(e){let r=e.createTexture(),t=new Uint8Array([0,0,255,255]);return e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.MIRRORED_REPEAT),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),r}function C(e){let r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),e.STATIC_DRAW);let t=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,t),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),e.STATIC_DRAW),{vertexBuff:r,texBuff:t}}function _(e){let r=w(e,e.VERTEX_SHADER,p),t=w(e,e.FRAGMENT_SHADER,x),i=e.createProgram();if(!i)throw new Error("Failed to create program");e.attachShader(i,r),e.attachShader(i,t),e.linkProgram(i),e.useProgram(i);let o=e.getAttribLocation(i,"a_position"),s=e.getAttribLocation(i,"a_texcoord"),n=e.getUniformLocation(i,"borderWidthPx"),a=e.getUniformLocation(i,"borderColor"),m=e.getUniformLocation(i,"viewportSize");return{program:i,vloc:o,tloc:s,borderWidthLoc:n,borderColorLoc:a,viewportSizeLoc:m}}function u(e,r={}){let t=e.getContext("webgl",{antialias:!1,depth:!1,stencil:!1,alpha:!1,desynchronized:!0,failIfMajorPerformanceCaveat:!1}),i=A(t),{program:o,vloc:s,tloc:n,borderWidthLoc:a,borderColorLoc:m,viewportSizeLoc:b}=_(t),{vertexBuff:R,texBuff:v}=C(t),g=Math.max(r.borderWidthPx||0,0),T=r.borderColor||[1,1,1,1];return t.useProgram(o),t.uniform1f(a,g),t.uniform4fv(m,new Float32Array(T)),t.uniform2f(b,t.canvas.width,t.canvas.height),t.bindTexture(t.TEXTURE_2D,i),t.uniform1i(t.getUniformLocation(o,"external_texture"),0),t.bindBuffer(t.ARRAY_BUFFER,R),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(s),t.bindBuffer(t.ARRAY_BUFFER,v),t.vertexAttribPointer(n,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(n),t.viewport(0,0,t.canvas.width,t.canvas.height),{canvas:e,gl:t,render:()=>{t.drawArrays(t.TRIANGLE_STRIP,0,4),t.finish()},resize:(c,d)=>{t.viewport(0,0,c,d),t.canvas.width=c,t.canvas.height=d,t.uniform2f(b,c,d)},setBorder:(c,d)=>{t.useProgram(o),t.uniform1f(a,Math.max(c,0)),d&&t.uniform4fv(m,new Float32Array(d))}}}function P(e){let r=atob(e.split(",")[1]),t=e.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(r.length),o=new Uint8Array(i);for(let n=0;n<r.length;n++)o[n]=r.charCodeAt(n);return new Blob([i],{type:t})}var f=class{recognitionCanvas;recoginitionView;gameCanvas;gameView;recording;constructor(){window.addEventListener("resize",this.resize.bind(this),{passive:!0}),this.recognitionCanvas=document.createElement("canvas"),this.recognitionCanvas.style.display="none",this.recognitionCanvas.style.pointerEvents="none",this.recognitionCanvas.width=window.innerWidth,this.recognitionCanvas.height=window.innerHeight,document.body.append(this.recognitionCanvas),this.recoginitionView=u(this.recognitionCanvas,{borderWidthPx:2,borderColor:[1,1,1,1]}),this.gameCanvas=document.createElement("canvas"),this.gameCanvas.style.display="none",this.gameCanvas.style.pointerEvents="none",this.gameCanvas.width=window.innerWidth,this.gameCanvas.height=window.innerHeight,document.body.append(this.gameCanvas),this.gameView=u(this.gameCanvas),this.recording=!1}resize(){let r=window.innerWidth,t=window.innerHeight;this.gameView.resize(r,t),this.recoginitionView.resize(r,t)}requestScreenshot(r){return new Promise(t=>{requestAnimationFrame(()=>{this.gameView.render(),r.encoding||(r.encoding="jpg"),r.quality||(r.quality=.92);let i="image/png";switch(r.encoding){case"jpg":i="image/jpeg";break;case"png":i="image/png";break;case"webp":i="image/webp";break}let o=this.gameCanvas.toDataURL(i,r.quality),s=()=>{let n=new FormData;return n.append(r.targetField,P(o),`screenshot.${r.encoding}`),n};r.targetURL&&fetch(r.targetURL,{method:"POST",mode:"cors",headers:{"User-Agent":"EAC-Client/1.0"},body:r.targetField?s():JSON.stringify({data:o,id:r.id,dimensions:{width:window.innerWidth,height:window.innerHeight}})}).then(n=>n.json()).then(n=>{h("screenshotCreated",{data:n,id:r.id})}).catch(()=>{}),t({data:o,id:r.id,dimensions:{width:window.innerWidth,height:window.innerHeight}})})})}requestRecording(r){let t=this.start(),i=new MediaRecorder(t,{mimeType:"video/webm",videoBitsPerSecond:524288,audioBitsPerSecond:0});return i.ondataavailable=o=>{let s=new Blob([o.data],{type:"video/webm"}),n=()=>{let a=new FormData;return a.append(r.targetField,s,"recording.webm"),a};r.targetURL&&fetch(r.targetURL,{method:"POST",mode:"cors",headers:{"User-Agent":"EAC-Client/1.0"},body:r.targetField?n():JSON.stringify({id:r.id,dimensions:{width:window.innerWidth,height:window.innerHeight}})}).then(a=>a.json()).then(a=>{h("recordingCreated",{data:a,id:r.id})}).catch(()=>{})},i.start(),setTimeout(()=>{this.stop(),i.stop()},r.duration),{id:r.id,dimensions:{width:window.innerWidth,height:window.innerHeight}}}start(){if(!this.recording){this.recording=!0;let r=()=>{this.gameView.render(),this.recording&&requestAnimationFrame(r)};requestAnimationFrame(r)}return this.gameCanvas.captureStream(30)}stop(){this.recording=!1}},E=new f;window.addEventListener("message",e=>{e.data.screenshotRequest&&E.requestScreenshot(e.data.screenshotRequest),e.data.recordingRequest&&E.requestRecording(e.data.recordingRequest)});export{E as a};
